<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTCI Comparison Dashboard | Brunei Darussalam</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --accent-color: #42a5f5;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success: #2e7d32;
            --danger: #c62828;
            --neutral: #757575;
            --sidebar-width: 400px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll, handle in views */
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .sidebar-toggle-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .sidebar-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Navigation Tabs */
        .nav-tabs-container {
            display: flex;
            background-color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background-color: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
        }

        .nav-tab:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            color: white;
            border-bottom-color: var(--accent-color);
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* VIEW WRAPPERS */
        #dashboard-view {
            display: flex;
            flex: 1;
            overflow: hidden; /* Internal scrolling */
            height: 100%;
        }

        #pdf-view {
            display: none; /* Hidden by default */
            flex: 1;
            overflow-y: auto;
            height: 100%;
            background-color: #525659; /* Standard PDF viewer bg */
            padding: 20px;
        }

        /* DASHBOARD STYLES */
        .input-panel {
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: margin-left 0.3s ease;
            z-index: 10;
            height: 100%; 
        }

        .input-panel.collapsed {
            margin-left: calc(-1 * var(--sidebar-width));
        }

        .input-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: #fafafa;
        }

        .input-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .global-rank-inputs {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 0.5rem;
            background: #e3f2fd;
            border-radius: 4px;
        }

        .rank-field label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .rank-field input {
            width: 60px;
            padding: 0.3rem;
            border: 1px solid #90caf9;
            border-radius: 4px;
        }

        .input-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }

        .input-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .pillar-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            background: #e3f2fd;
            padding: 0.4rem;
            border-radius: 4px;
        }

        .indicator-item {
            margin-bottom: 0.8rem;
            padding: 0.8rem;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .indicator-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .indicator-inputs {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-field { flex: 1; }
        .input-field label { display: block; font-size: 0.65rem; color: #666; margin-bottom: 2px; }
        .input-field input { width: 100%; padding: 0.4rem; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9rem; }
        .remark-field { flex: 1.5; }
        .remark-field input { width: 100%; font-size: 0.8rem; }

        .dashboard-panel {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-color);
            transition: margin-left 0.3s;
        }

        /* Ranking Board */
        .ranking-board {
            display: flex;
            gap: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            justify-content: space-around;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .rank-card { text-align: center; }
        .rank-card h3 { font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .rank-card .big-number { font-size: 2.5rem; font-weight: 800; }
        .rank-card .diff { font-size: 0.9rem; background: rgba(255, 255, 255, 0.2); padding: 0.2rem 0.5rem; border-radius: 12px; }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-title { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; }
        .card-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .trend-value { font-size: 1rem; font-weight: 600; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.3rem; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--neutral); }

        /* Charts & Tables */
        .chart-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            height: 400px;
        }

        .table-container {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .table-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; }
        .table-filters { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .filter-btn { padding: 0.4rem 0.8rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .filter-btn.active { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.8rem; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: #444; cursor: pointer; background: #fafafa; }
        
        .score-cell { font-family: monospace; font-size: 1rem; }
        .indicator-badge { display: inline-block; font-size: 0.65rem; font-weight: 600; padding: 2px 6px; border-radius: 3px; margin-left: 6px; text-transform: uppercase; }
        .badge-replaced { background-color: #fee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .badge-new { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .badge-code-changed { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }

        /* PDF Viewer Specific */
        .pdf-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .pdf-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .pdf-btn:hover { background: var(--secondary-color); }
        .pdf-btn:disabled { background: #ccc; cursor: not-allowed; }

        .pdf-canvas-container {
            display: flex;
            justify-content: center;
            background: #525659;
            min-height: 80vh;
        }
        
        #pdfCanvas {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-width: 100%;
        }

        /* Intelligent Query Box */
        .iq-box {
            position: fixed; bottom: 20px; right: 20px; width: 400px; 
            background: white; border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); z-index: 1000; padding: 20px;
        }

        @media (max-width: 900px) {
            #dashboard-view { flex-direction: column; overflow: auto; }
            .input-panel { width: 100%; height: auto; max-height: 400px; margin-left: 0 !important; }
            .sidebar-toggle-btn { display: none; }
            .iq-box { width: 90%; left: 5%; right: 5%; }
        }
    </style>
</head>

<body>

    <header>
        <div class="header-content">
            <div style="display: flex; flex-direction: column; margin-left: 1rem;">
                <span style="font-variant: small-caps; font-size: 0.8rem; font-weight: 500; opacity: 0.9; line-height: 1;">by sfzn</span>
                <h1 style="margin-left: 0;">GTCI Dashboard | Brunei Darussalam</h1>
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9;">2023 vs 2025 Comparison</div>
        </div>
    </header>

    <div class="nav-tabs-container">
        <button class="nav-tab active" id="tab-dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="nav-tab" id="tab-report" onclick="switchTab('report')">üìÑ GTCI Report (PDF)</button>
    </div>

    <div id="dashboard-view">
        

        <main class="dashboard-panel">
            
            <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-bottom: 2px solid #1976d2; padding: 1.5rem 2rem; margin-bottom: 2rem; border-radius: 8px;">
                <h2 style="color: #0d47a1; margin-bottom: 0.5rem; font-size: 1.3rem;">üìä Intelligent Data Query System</h2>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="queryInput" placeholder="e.g., 'How many indicators improved?'" style="flex: 1; padding: 0.8rem; border: 2px solid #90caf9; border-radius: 6px;">
                    <button onclick="executeQuery()" class="btn btn-primary">üîç Query</button>
                    <button onclick="clearQueryResponse()" class="btn" style="background: #757575; color: white;">Clear</button>
                </div>
                <div id="queryResponse" style="background: white; border-left: 4px solid #1976d2; padding: 1.5rem; border-radius: 6px; display: none;">
                    <h3 id="queryTitle" style="color: #0d47a1; margin-bottom: 1rem;"></h3>
                    <div id="responseContent" style="color: #333; line-height: 1.7;"></div>
                </div>
            </div>

            <div class="ranking-board">
                <div class="rank-card">
                    <h3>Global Rank 2023</h3>
                    <div class="big-number" id="displayRank2023">41</div>
                </div>
                <div class="rank-card">
                    <h3>Global Rank 2025</h3>
                    <div class="big-number" id="displayRank2025">43</div>
                    <div class="diff" id="rankDiff">‚ñº 2</div>
                </div>
                <div class="rank-card">
                    <h3>Score 2023</h3>
                    <div class="big-number" id="displayScore2023">--</div>
                </div>
                <div class="rank-card">
                    <h3>Score 2025</h3>
                    <div class="big-number" id="displayScore2025">--</div>
                    <div class="diff" id="scoreDiff">--</div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="card" onclick="setFilter('status', 'all', null)">
                    <div class="card-title">Net Score Change</div>
                    <div class="card-value" id="netChange">--</div>
                    <div class="trend-value" id="netTrend"></div>
                </div>
                <div class="card" onclick="setFilter('status', 'improved', null)">
                    <div class="card-title">Improved Indicators</div>
                    <div class="card-value" id="improvedCount" style="color: var(--success)">--</div>
                </div>
                <div class="card" onclick="setFilter('status', 'declined', null)">
                    <div class="card-title">Declined Indicators</div>
                    <div class="card-value" id="declinedCount" style="color: var(--danger)">--</div>
                </div>
                <div class="card" onclick="setFilter('status', 'missing', null)">
                    <div class="card-title">Missing/Zero Data ('25)</div>
                    <div class="card-value" id="missingCount" style="color: #ff9800">--</div>
                </div>
            </div>

            <div style="display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap;">
                <div class="chart-container" style="flex: 1; min-width: 300px;">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="chart-container" style="flex: 1; min-width: 300px;">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3>Detailed Breakdown <span id="indicatorCount" style="font-size: 0.8em; color: #666;"></span></h3>
                    <div class="table-filters">
                                    <div class="table-filters">
                <button class="filter-btn year-filter-btn active" data-year="2025" onclick="setFilter('year', '2025')">2025 (77)</button>
                <button class="filter-btn year-filter-btn" data-year="2023" onclick="setFilter('year', '2023')">2023 (69)</button>
            </div>
                        <input type="text" placeholder="Search code/name..." style="padding: 0.4rem;" oninput="setFilter('search', this.value)">
                        <button class="filter-btn active" onclick="setFilter('status', 'all', this)">All</button>
                        <button class="filter-btn" onclick="setFilter('status', 'improved', this)">Improved</button>
                        <button class="filter-btn" onclick="setFilter('status', 'declined', this)">Declined</button>
                        <button class="filter-btn" onclick="setFilter('status', 'missing', this)">Missing</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('code')">Code ‚Üï</th>
                            <th onclick="sortTable('name')">Name ‚Üï</th>
                            <th id="th-2023" onclick="sortTable('score2023')">2023 ‚Üï</th>
                            <th id="th-2025" onclick="sortTable('score2025')">2025 ‚Üï</th>
                            <th id="th-diff" onclick="sortTable('diff')">Change ‚Üï</th>
                            <th>Owner</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </main>
        
    </div>

    <div id="pdf-view">
        <div class="pdf-controls">
            <button class="pdf-btn" onclick="changePage(-1)">‚Üê Previous</button>
            <span id="page_num_label" style="font-weight:bold;">Page 1</span>
            <button class="pdf-btn" onclick="changePage(1)">Next ‚Üí</button>
            <div style="width: 20px;"></div>
            <button class="pdf-btn" onclick="zoomPdf(0.2)">+</button>
            <button class="pdf-btn" onclick="zoomPdf(-0.2)">-</button>
            <div style="width: 20px;"></div>
            <a href="2025%20Brunei%20GTCI%20Ranking%20(1).pdf" download class="pdf-btn" style="text-decoration:none; background-color: var(--success);">‚¨á Download</a>
        </div>
        
        <div class="pdf-canvas-container">
            <canvas id="pdfCanvas"></canvas>
        </div>
    </div>

    <script>
        // --- DATA MODEL (PRESERVED) ---
        const detailedIndicators = [
            // 1. ENABLE
            { code: "1.1.1", name: "Government effectiveness", pillar: "Enable", subpillar: "1.1 Regulatory Landscape", score2023: 79.14, score2025: 80.06, source: "World Bank", dataOwner: "Prime Minister's Office (PMO)" },
            { code: "1.1.2", name: "Rule of law", pillar: "Enable", subpillar: "1.1 Regulatory Landscape", score2023: 68.96, score2025: 73.77, source: "World Bank", dataOwner: "Attorney General's Chambers (AGC)" },
            { code: "1.1.3", name: "Political stability", pillar: "Enable", subpillar: "1.1 Regulatory Landscape", score2023: 91.56, score2025: 98.60, source: "World Bank", dataOwner: "Internal Security Department (ISD)" },
            { code: "1.1.4", name: "Regulatory quality", pillar: "Enable", subpillar: "1.1 Regulatory Landscape", score2023: 67.88, score2025: 69.28, source: "World Bank", dataOwner: "Prime Minister's Office (PMO)" },
            { code: "1.1.5", name: "Corruption", pillar: "Enable", subpillar: "1.1 Regulatory Landscape", score2023: null, score2025: null, source: "Transparency International", dataOwner: "Anti-Corruption Bureau (ACB)" },
            { code: "1.2.1", name: "Extent of market dominance", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 30.71, score2025: 39.42, source: "WEF", dataOwner: "CCBD" },
            { code: "1.2.2", name: "Domestic credit to private sector", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 35.42, score2025: 15.42, source: "IMF/WB", dataOwner: "BDCB" },
            { code: "1.2.3", name: "Cluster development", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 44.47, score2025: 44.29, source: "WEF", dataOwner: "MOFE" },
            { code: "1.2.4", name: "R&D expenditure", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 5.00, score2025: 4.29, source: "WIPO", dataOwner: "Brunei Research Council" },
            { code: "1.2.5", name: "ICT Infrastructure", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 0.00, score2025: null, source: "", dataOwner: "AITI", indicatorStatus: "replaced", replacedBy: "1.2.5" },
            { code: "1.2.5", name: "Population covered by at least a 3G mobile network", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: null, score2025: 93.09, source: "ITU", dataOwner: "AITI", indicatorStatus: "new" },
            { code: "1.2.6", name: "Urbanisation", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: 74.28, score2025: null, source: "UN", dataOwner: "TCP", indicatorStatus: "replaced", replacedBy: "1.2.7" },
            { code: "1.2.6", name: "Internet access in schools", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: null, score2025: null, source: "UNESCO", dataOwner: "MOE", indicatorStatus: "new" },
            { code: "1.2.7", name: "Urbanisation", pillar: "Enable", subpillar: "1.2 Market Landscape", score2023: null, score2025: 75.76, source: "UN", dataOwner: "TCP", indicatorStatus: "code-changed" },
            { code: "1.3.1", name: "Labour rights", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: null, score2025: 74.20, source: "ILO", dataOwner: "Labour Department" },
            { code: "1.3.2", name: "Labour-employer cooperation", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: 51.20, score2025: 60.53, source: "WEF", dataOwner: "Labour Department" },
            { code: "1.3.3", name: "Professional management", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: 42.44, score2025: 60.63, source: "WEF", dataOwner: "DARe" },
            { code: "1.3.4", name: "Relationship of pay to productivity", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: 55.17, score2025: 46.51, source: "WEF", dataOwner: "MPEC" },
            { code: "1.3.5", name: "Enterprise software", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: 11.53, score2025: 11.86, source: "Statista", dataOwner: "AITI" },
            { code: "1.3.6", name: "Cloud computing", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: 6.76, score2025: 4.79, source: "Statista", dataOwner: "AITI" },
            { code: "1.3.7", name: "Firms with website", pillar: "Enable", subpillar: "1.3 Business and Labour Landscape", score2023: null, score2025: null, source: "OECD", dataOwner: "AITI / DEPS" },
            // 2. ATTRACT
            { code: "2.1.1", name: "FDI regulatory restrictiveness", pillar: "Attract", subpillar: "2.1 External Openness", score2023: 61.62, score2025: 54.68, source: "OECD", dataOwner: "BEDB" },
            { code: "2.1.2", name: "Financial globalisation", pillar: "Attract", subpillar: "2.1 External Openness", score2023: 85.47, score2025: 78.93, source: "KOF", dataOwner: "MOFE" },
            { code: "2.1.3", name: "Migrant stock", pillar: "Attract", subpillar: "2.1 External Openness", score2023: 78.84, score2025: 49.50, source: "UN", dataOwner: "INRD" },
            { code: "2.1.4", name: "International students", pillar: "Attract", subpillar: "2.1 External Openness", score2023: 13.39, score2025: 15.76, source: "UNESCO", dataOwner: "MOE" },
            { code: "2.1.5", name: "Brain gain", pillar: "Attract", subpillar: "2.1 External Openness", score2023: null, score2025: 66.32, source: "WEF", dataOwner: "MPEC" },
            { code: "2.1.6", name: "AI skills migration", pillar: "Attract", subpillar: "2.1 External Openness", score2023: null, score2025: null, source: "OECD.AI", dataOwner: "AITI", indicatorStatus: "new" },
            { code: "2.2.1", name: "Tolerance of minorities", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: 30.85, score2025: 27.66, source: "Fragile States Index", dataOwner: "JAPEM / MORA" },
            { code: "2.2.2", name: "Tolerance of immigrants", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: null, score2025: null, source: "Gallup", dataOwner: "INRD" },
            { code: "2.2.3", name: "Social mobility", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: 36.36, score2025: 60.68, source: "WEF", dataOwner: "JAPEM / MPEC" },
            { code: "2.2.4", name: "Economic empowerment of women", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: 33.63, score2025: 53.12, source: "WB", dataOwner: "JAPEM" },
            { code: "2.2.5", name: "Gender parity in high-skilled jobs", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: 83.85, score2025: 82.62, source: "ILO", dataOwner: "Labour Dept" },
            { code: "2.2.6", name: "Leadership opportunities for women", pillar: "Attract", subpillar: "2.2 Internal Openness", score2023: 53.24, score2025: 71.54, source: "WEF", dataOwner: "JAPEM" },
            // 3. GROW
            { code: "3.1.1", name: "Vocational enrolment", pillar: "Grow", subpillar: "3.1 Formal Education", score2023: 18.17, score2025: 20.87, source: "UNESCO", dataOwner: "IBTE" },
            { code: "3.1.2", name: "Tertiary enrolment", pillar: "Grow", subpillar: "3.1 Formal Education", score2023: 20.46, score2025: 20.55, source: "UNESCO", dataOwner: "MOE" },
            { code: "3.1.3", name: "Tertiary education expenditure", pillar: "Grow", subpillar: "3.1 Formal Education", score2023: 86.29, score2025: 50.31, source: "UNESCO", dataOwner: "MOE / MOFE" },
            { code: "3.1.4", name: "Reading, maths and science", pillar: "Grow", subpillar: "3.1 Formal Education", score2023: 36.31, score2025: 42.06, source: "OECD (PISA)", dataOwner: "MOE" },
            { code: "3.1.5", name: "University ranking", pillar: "Grow", subpillar: "3.1 Formal Education", score2023: 35.36, score2025: 17.53, source: "QS", dataOwner: "UBD / UTB" },
            { code: "3.2.1", name: "Business masters education", pillar: "Grow", subpillar: "3.2 Lifelong Learning", score2023: 0.00, score2025: 0.00, source: "QS", dataOwner: "UBD / UTB" },
            { code: "3.2.2", name: "Prevalence of training in firms", pillar: "Grow", subpillar: "3.2 Lifelong Learning", score2023: null, score2025: null, source: "WB", dataOwner: "MPEC" },
            { code: "3.2.3", name: "Employee development", pillar: "Grow", subpillar: "3.2 Lifelong Learning", score2023: 61.96, score2025: 62.24, source: "WEF", dataOwner: "MPEC" },
            { code: "3.3.1", name: "Delegation of authority", pillar: "Grow", subpillar: "3.3 Access to Growth Opportunities", score2023: 63.34, score2025: 65.69, source: "WEF", dataOwner: "MPEC" },
            { code: "3.3.2", name: "Youth inclusion", pillar: "Grow", subpillar: "3.3 Access to Growth Opportunities", score2023: 62.04, score2025: 67.31, source: "ILO", dataOwner: "MCYS" },
            { code: "3.3.3", name: "Use of virtual social networks", pillar: "Grow", subpillar: "3.3 Access to Growth Opportunities", score2023: 89.20, score2025: 63.50, source: "We Are Social", dataOwner: "AITI" },
            { code: "3.3.4", name: "Use of virtual professional networks", pillar: "Grow", subpillar: "3.3 Access to Growth Opportunities", score2023: 36.47, score2025: 36.47, source: "We Are Social", dataOwner: "AITI" },
            // 4. RETAIN
            { code: "4.1.1", name: "Pension coverage", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: 100.00, score2025: 100.00, source: "ILO", dataOwner: "TAP" },
            { code: "4.1.2", name: "Social protection", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: 55.97, score2025: 50.00, source: "WEF", dataOwner: "JAPEM" },
            { code: "4.1.3", name: "Brain retention", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: 42.74, score2025: 48.17, source: "WEF", dataOwner: "MPEC" },
            { code: "4.1.4", name: "Environmental performance", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: 45.42, score2025: 48.30, source: "Yale", dataOwner: "JASTRe" },
            { code: "4.1.5", name: "Vulnerable employment", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: 92.87, score2025: 95.02, source: "WB", dataOwner: "Labour Dept" },
            { code: "4.1.6", name: "Protect against future disasters", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: null, score2025: null, source: "Gallup", dataOwner: "NDMC", indicatorStatus: "new" },
            { code: "4.1.7", name: "Household financial resilience", pillar: "Retain", subpillar: "4.1 Sustainability", score2023: null, score2025: null, source: "Gallup", dataOwner: "MOFE / BDCB", indicatorStatus: "new" },
            { code: "4.2.1", name: "Personal rights", pillar: "Retain", subpillar: "4.2 Lifestyle", score2023: null, score2025: null, source: "Social Progress Index", dataOwner: "AGC" },
            { code: "4.2.2", name: "Personal safety", pillar: "Retain", subpillar: "4.2 Lifestyle", score2023: null, score2025: null, source: "Social Progress Index", dataOwner: "RBPF" },
            { code: "4.2.3", name: "Physician density", pillar: "Retain", subpillar: "4.2 Lifestyle", score2023: 29.78, score2025: 27.37, source: "WHO", dataOwner: "MOH" },
            { code: "4.2.4", name: "Sanitation", pillar: "Retain", subpillar: "4.2 Lifestyle", score2023: 95.99, score2025: 98.00, source: "WHO", dataOwner: "MOD / MOH" },
            { code: "4.2.5", name: "Employee wellbeing", pillar: "Retain", subpillar: "4.2 Lifestyle", score2023: null, score2025: null, source: "Gallup", dataOwner: "MPEC", indicatorStatus: "new" },
            // 5. VOCATIONAL
            { code: "5.1.1", name: "Workforce with secondary education", pillar: "Vocational & Technical Skills", subpillar: "5.1 Mid-level Skills", score2023: 73.23, score2025: 62.63, source: "ILO", dataOwner: "MOE" },
            { code: "5.1.2", name: "Population with secondary education", pillar: "Vocational & Technical Skills", subpillar: "5.1 Mid-level Skills", score2023: null, score2025: 63.94, source: "UNESCO", dataOwner: "DEPS", indicatorStatus: "new" },
            { code: "5.1.3", name: "Technicians and associate professionals", pillar: "Vocational & Technical Skills", subpillar: "5.1 Mid-level Skills", score2023: 50.12, score2025: 57.06, source: "ILO", dataOwner: "Labour Dept" },
            { code: "5.1.4", name: "Labour productivity per employee", pillar: "Vocational & Technical Skills", subpillar: "5.1 Mid-level Skills", score2023: null, score2025: null, source: "Conference Board", dataOwner: "DEPS" },
            { code: "5.2.1", name: "Ease of finding skilled employees", pillar: "Vocational & Technical Skills", subpillar: "5.2 Employability", score2023: 44.76, score2025: 42.88, source: "WEF", dataOwner: "JobCentre Brunei" },
            { code: "5.2.2", name: "Relevance of education system", pillar: "Vocational & Technical Skills", subpillar: "5.2 Employability", score2023: 63.96, score2025: 60.78, source: "WEF", dataOwner: "MOE / MPEC" },
            { code: "5.2.3", name: "Skills matching", pillar: "Vocational & Technical Skills", subpillar: "5.2 Employability", score2023: 66.81, score2025: 65.70, source: "ILO", dataOwner: "MPEC" },
            { code: "5.2.4", name: "Highly educated unemployment", pillar: "Vocational & Technical Skills", subpillar: "5.2 Employability", score2023: 84.32, score2025: 83.21, source: "ILO", dataOwner: "Labour Dept" },
            // 6. GLOBAL KNOWLEDGE
            { code: "6.1.1", name: "Workforce with tertiary education", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: 27.70, score2025: 35.56, source: "ILO", dataOwner: "MOE" },
            { code: "6.1.2", name: "Population with tertiary education", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: null, score2025: null, source: "UNESCO", dataOwner: "MOE", indicatorStatus: "replaced", replacedBy: "6.1.2 Soft skills" },
            { code: "6.1.2", name: "Soft skills", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: null, score2025: 57.13, source: "WEF", dataOwner: "MPEC", indicatorStatus: "new" },
            { code: "6.1.3", name: "Professionals", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: 34.51, score2025: 33.81, source: "ILO", dataOwner: "Labour Dept" },
            { code: "6.1.4", name: "Researchers", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: null, score2025: 4.82, source: "UNESCO", dataOwner: "BRC" },
            { code: "6.1.5", name: "Senior officials and managers", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: 38.10, score2025: 45.11, source: "ILO", dataOwner: "JPA / Labour" },
            { code: "6.1.6", name: "Digital skills", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: 100.00, score2025: 100.00, source: "ITU", dataOwner: "AITI" },
            { code: "6.1.7", name: "AI talent concentration", pillar: "Global Knowledge Skills", subpillar: "6.1 High-level Skills", score2023: null, score2025: null, source: "OECD.AI", dataOwner: "AITI", indicatorStatus: "new" },
            { code: "6.2.1", name: "ICT services exports", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: null, score2025: 2.44, source: "WTO", dataOwner: "DEPS", indicatorStatus: "new" },
            { code: "6.2.2", name: "Mobile apps development", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: null, score2025: 43.27, source: "data.ai", dataOwner: "AITI", indicatorStatus: "new" },
            { code: "6.2.3", name: "Intellectual property receipts", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: null, score2025: 0.00, source: "WTO", dataOwner: "BruIPO", indicatorStatus: "new" },
            { code: "6.2.4", name: "High-value exports", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: 2.24, score2025: 1.53, source: "WB", dataOwner: "DEPS" },
            { code: "6.2.5", name: "Software development", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: 59.20, score2025: 3.02, source: "GitHub", dataOwner: "AITI" },
            { code: "6.2.6", name: "New business density", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: 5.33, score2025: 0.00, source: "WB", dataOwner: "ROCBN" },
            { code: "6.2.7", name: "Scientific journal articles", pillar: "Global Knowledge Skills", subpillar: "6.2 Talent Impact", score2023: 24.29, score2025: 32.91, source: "WB", dataOwner: "UBD" }
        ];

        const pillarDataStructure = [
            { id: "1", name: "Enable", score2023: 49.43, rank2023: 51, score2025: 56.30, rank2025: 43 },
            { id: "2", name: "Attract", score2023: 53.71, rank2023: 54, score2025: 56.08, rank2025: 46 },
            { id: "3", name: "Grow", score2023: 44.35, rank2023: 46, score2025: 39.88, rank2025: 55 },
            { id: "4", name: "Retain", score2023: 65.15, rank2023: 49, score2025: 65.49, rank2025: 39 },
            { id: "5", name: "Vocational & Technical Skills", score2023: 63.32, rank2023: 26, score2025: 62.18, rank2025: 33 },
            { id: "6", name: "Global Knowledge Skills", score2023: 34.47, rank2023: 45, score2025: 28.98, rank2025: 50 }
        ];

        let indicators = [];
        let currentSort = { key: 'code', dir: 'asc' };
let filters = { status: new Set(), search: '', year: '2025' };        let myChart = null;
        let myRadarChart = null;
        let isLocked = false;
        let sidebarCollapsed = false;

        // --- DASHBOARD LOGIC ---
        function initIndicators() {
            indicators = detailedIndicators.map((item, index) => {
                return {
                    id: `ind_${index + 1}`,
                    ...item,
                    is2023Only: (item.code === '1.2.5' && item.name === 'ICT Infrastructure') || (item.code === '1.2.6' && item.name === 'Urbanisation')
                };
            });
        }

        function renderInputs() {
            const container = document.getElementById('inputContainer');
            container.innerHTML = '';
            let currentSubpillar = '';
            let disabledAttr = isLocked ? 'disabled' : '';

            indicators.forEach(ind => {
                if (ind.subpillar !== currentSubpillar) {
                    const header = document.createElement('div');
                    header.className = 'pillar-title';
                    header.innerHTML = `<small>${ind.pillar}</small><br>${ind.subpillar.substring(4)}`;
                    container.appendChild(header);
                    currentSubpillar = ind.subpillar;
                }

                const item = document.createElement('div');
                item.className = 'indicator-item';
                const s23 = ind.score2023 !== null ? ind.score2023 : '';
                const s25 = ind.score2025 !== null ? ind.score2025 : '';

                item.innerHTML = `
                <span class="indicator-label"><strong>${ind.code}</strong> ${ind.name}</span>
                <div class="indicator-inputs">
                    <div class="input-field">
                        <label>2023</label>
                        <input type="number" value="${s23}" ${disabledAttr} onchange="updateScore('${ind.id}', '2023', this.value)">
                    </div>
                    <div class="input-field">
                        <label>2025</label>
                        <input type="number" value="${s25}" ${disabledAttr} onchange="updateScore('${ind.id}', '2025', this.value)">
                    </div>
                </div>`;
                container.appendChild(item);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let filtered = indicators.filter(ind => {
                // Filter logic
                            // Year-based filtering
            if(filters.year === '2023') {
                if(ind.indicatorStatus === 'new' || ind.indicatorStatus === 'replaced') return false;
            }
                            if(filters.year === '2025') {
                if(ind.indicatorStatus === 'replaced') return false;
            }
                if (filters.search) {
                    const q = filters.search.toLowerCase();
                    if (!ind.code.toLowerCase().includes(q) && !ind.name.toLowerCase().includes(q)) return false;
                }
                
                if (filters.status.size > 0) {
                    const s23 = ind.score2023 || 0;
                    const s25 = ind.score2025 || 0;
                    const diff = s25 - s23;
                    
                    let match = false;
                    if (filters.status.has('improved') && diff > 0 && ind.score2025 !== null) match = true;
                    if (filters.status.has('declined') && diff < 0 && ind.score2025 !== null) match = true;
                    if (filters.status.has('missing') && !ind.is2023Only && (ind.score2025 === null || ind.score2025 === 0)) match = true;
                    if (filters.status.has('all')) match = true; // Should not happen with current logic but safe to have
                    
                    if (!match) return false;
                }
                return true;
            });

            // Sort
            filtered.sort((a, b) => {
                let valA = a[currentSort.key] || 0;
                let valB = b[currentSort.key] || 0;
                if (currentSort.key === 'diff') {
                    valA = (a.score2025 || 0) - (a.score2023 || 0);
                    valB = (b.score2025 || 0) - (b.score2023 || 0);
                }
                if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });

            document.getElementById('indicatorCount').textContent = `(${filtered.length})`;

            filtered.forEach(ind => {
                const s23 = ind.score2023 === null ? 'n/a' : ind.score2023;
                const s25 = ind.score2025 === null ? 'n/a' : ind.score2025;
                let diffStr = '--';
                let trendClass = 'trend-neutral';

                if (ind.score2025 !== null && ind.score2023 !== null) {
                    const diff = (ind.score2025 - ind.score2023).toFixed(2);
                    if (diff > 0) { trendClass = 'trend-up'; diffStr = '+' + diff; }
                    else if (diff < 0) { trendClass = 'trend-down'; diffStr = diff; }
                    else { diffStr = '0.0'; }
                }

                let badge = '';
                if (ind.indicatorStatus === 'new') badge = '<span class="indicator-badge badge-new">New</span>';
                if (ind.indicatorStatus === 'replaced') badge = '<span class="indicator-badge badge-replaced">Replaced</span>';
                if (ind.indicatorStatus === 'code-changed') badge = '<span class="indicator-badge badge-code-changed">Code</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${ind.code}${badge}</td>
                    <td>${ind.name}</td>
                    <td class="score-cell">${s23}</td>
                    <td class="score-cell">${s25}</td>
                    <td class="score-cell ${trendClass}">${diffStr}</td>
                    <td style="font-size:0.85rem">${ind.dataOwner}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSummary() {
            // Recalculate based on input
            const valid2025 = indicators.filter(i => i.score2025 !== null && !i.is2023Only);
            const valid2023 = indicators.filter(i => i.score2023 !== null);
            
            // Just sum logic for simple average demo
            const sum25 = valid2025.reduce((a,b) => a + Number(b.score2025), 0);
            const avg25 = valid2025.length ? (sum25 / valid2025.length).toFixed(2) : '--';

            // Use hardcoded reference for 2023/2025 global if inputs not fully populated, 
            // but let's update counts dynamically
            const universe = indicators.filter(i => !i.is2023Only && i.indicatorStatus !== 'replaced');
            const improved = universe.filter(i => i.score2025 !== null && i.score2023 !== null && (i.score2025 - i.score2023) > 0).length;
            const declined = universe.filter(i => i.score2025 !== null && i.score2023 !== null && (i.score2025 - i.score2023) < 0).length;
            const missing = universe.filter(i => i.score2025 === null || i.score2025 === 0).length;

            document.getElementById('improvedCount').textContent = improved;
            document.getElementById('declinedCount').textContent = declined;
            document.getElementById('missingCount').textContent = missing;
            
            // Hardcoded display for top cards as per requirement to match report unless computed
            const sum23 = valid2023.reduce((a,b) => a + Number(b.score2023), 0);
    const avg23 = valid2023.length ? (sum23 / valid2023.length).toFixed(2) : '--';
    const scoreDiff = avg25 !== '--' && avg23 !== '--' ? (Number(avg25) - Number(avg23)).toFixed(2) : '--';
    let scoreDiffStr = '--', netChangeStr = '--';
    
    if (scoreDiff !== '--') {
        scoreDiffStr = scoreDiff > 0 ? '‚ñ≤ ' + scoreDiff : '‚ñº ' + Math.abs(scoreDiff);
        netChangeStr = scoreDiff > 0 ? '+' + scoreDiff : scoreDiff;
    }
    
    document.getElementById('displayScore2023').textContent = avg23;
    document.getElementById('displayScore2025').textContent = avg25;
    document.getElementById('scoreDiff').textContent = scoreDiffStr;
    document.getElementById('netChange').textContent = netChangeStr;
    document.getElementById('netTrend').innerHTML = scoreDiff !== '--' ? (scoreDiff > 0 ? '<span class="trend-up">‚ñ≤ Improved</span>' : '<span class="trend-down">‚ñº Declined</span>') : '<span class="trend-neutral">--</span>';
        }

        function renderChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const labels = pillarDataStructure.map(p => p.name.split(' ')[0]);
            const d23 = pillarDataStructure.map(p => p.score2023);
            const d25 = pillarDataStructure.map(p => p.score2025);

            if (myChart) { myChart.destroy(); }
            
            myChart = new Chart(ctx, {
                plugins: [ChartDataLabels],
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2023', data: d23, backgroundColor: '#CFD8DC' },
                        { label: '2025', data: d25, backgroundColor: '#42a5f5' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: { anchor: 'end', align: 'top', formatter: Math.round }
                    },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function renderRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = pillarDataStructure.map(p => p.name.split(' ')[0]);
            const d23 = pillarDataStructure.map(p => p.score2023);
            const d25 = pillarDataStructure.map(p => p.score2025);

            if (myRadarChart) { myRadarChart.destroy(); }

            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2023', data: d23, borderColor: '#CFD8DC', backgroundColor: 'rgba(207, 216, 220, 0.2)' },
                        { label: '2025', data: d25, borderColor: '#42a5f5', backgroundColor: 'rgba(66, 165, 245, 0.2)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { beginAtZero: true, max: 100 } }
                }
            });
        }

        // --- INTERACTION ---
        function updateScore(id, year, val) {
            const item = indicators.find(i => i.id === id);
            if(item) {
                item['score'+year] = val === '' ? null : Number(val);
                802
                    ();
                renderTable();
            }
        }
        
        function updateRank() {
             const r23 = document.getElementById('rank2023Input').value;
             const r25 = document.getElementById('rank2025Input').value;
             document.getElementById('displayRank2023').textContent = r23;
             document.getElementById('displayRank2025').textContent = r25;
             const diff = r23 - r25; 
             const el = document.getElementById('rankDiff');
             el.textContent = (diff > 0 ? "‚ñ≤ " : diff < 0 ? "‚ñº " : "") + Math.abs(diff);
             el.style.color = diff > 0 ? "#b9f6ca" : "white";
        }

        function setFilter(type, val) {
            if(type === 'search') filters.search = val;
                if(type === 'year') { filters.year = val; document.querySelectorAll('.year-filter-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.year === val); }); }
            if(type === 'status') {
                if(val === 'all') filters.status.clear();
                else {
                    if(filters.status.has(val)) filters.status.delete(val);
                    else filters.status.add(val);
                }
                // Toggle active class on buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    const txt = btn.textContent.toLowerCase();
                    if(val === 'all' && txt === 'all') btn.classList.add('active');
                    else if(val !== 'all' && txt === 'all') btn.classList.remove('active');
                    
                    if(val !== 'all' && txt.includes(val)) btn.classList.toggle('active');
                });
            }
            renderTable();
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('collapsed');
        }

        function toggleLock() {
            isLocked = !isLocked;
            const btn = document.getElementById('lockBtn');
            if(isLocked) {
                btn.innerHTML = 'üîí Locked';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-outline');
            } else {
                btn.innerHTML = 'üîì Unlock';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            }
            renderInputs();
        }

        function resetData() {
            if(confirm("Clear inputs?")) {
                initIndicators();
                renderInputs();
                renderTable();
                updateSummary();
            }
        }
        
        function sortTable(key) {
            if(currentSort.key === key) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else { currentSort.key = key; currentSort.dir = 'asc'; }
            renderTable();
        }

        // --- INTELLIGENT QUERY ---
        function executeQuery() {
            const q = document.getElementById('queryInput').value.toLowerCase();
            const resp = document.getElementById('queryResponse');
            const content = document.getElementById('responseContent');
            const title = document.getElementById('queryTitle');
            
            resp.style.display = 'block';
            
            if(q.includes('improve')) {
                title.textContent = "Improved Indicators";
                const count = indicators.filter(i => (i.score2025 - i.score2023) > 0).length;
                content.textContent = `Found ${count} indicators that improved since 2023.`;
            } else if (q.includes('decline')) {
                title.textContent = "Declined Indicators";
                const count = indicators.filter(i => (i.score2025 - i.score2023) < 0).length;
                content.textContent = `Found ${count} indicators that declined.`;
            } else {
                title.textContent = "Search Results";
                const found = indicators.filter(i => i.name.toLowerCase().includes(q));
                content.innerHTML = found.length ? found.map(f => `<div><strong>${f.code}</strong>: ${f.name}</div>`).join('') : "No matches found.";
            }
        }
        function clearQueryResponse() { document.getElementById('queryResponse').style.display = 'none'; document.getElementById('queryInput').value=''; }
        function handleQuerySubmit() {
            const q = document.getElementById('intelligentQueryInput').value;
            const box = document.getElementById('queryResponseBox');
            const found = indicators.find(i => i.code === q || i.name.toLowerCase().includes(q.toLowerCase()));
            if(found) {
                box.innerHTML = `<strong>${found.code} ${found.name}</strong><br>2023: ${found.score2023}<br>2025: ${found.score2025}<br>Owner: ${found.dataOwner}`;
            } else {
                box.textContent = "No indicator found. Try entering a code like '1.1.1'";
            }
        }

        // --- PDF LOGIC ---
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        // URL ENCODED FILENAME
        const url = '2025%20Brunei%20GTCI%20Ranking%20(1).pdf';

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                // Adjust scale to fit width
                const containerWidth = document.querySelector('.pdf-canvas-container').clientWidth - 40;
                const viewport = page.getViewport({scale: 1});
                const desiredScale = containerWidth / viewport.width;
                // Limit max zoom automatically, but respect manual zoom if implemented
                const finalScale = scale * desiredScale;

                const scaledViewport = page.getViewport({scale: finalScale});
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('page_num_label').textContent = `Page ${num} of ${pdfDoc.numPages}`;
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function changePage(offset) {
            if (!pdfDoc) return;
            const newPage = pageNum + offset;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                queueRenderPage(pageNum);
            }
        }
        
        function zoomPdf(delta) {
            scale += delta;
            if(scale < 0.5) scale = 0.5;
            if(!pdfDoc) return;
            queueRenderPage(pageNum);
        }

        // --- TAB SWITCHER (WRAPPER LOGIC) ---
        function switchTab(tab) {
            const dashboard = document.getElementById('dashboard-view');
            const pdf = document.getElementById('pdf-view');
            const btnDash = document.getElementById('tab-dashboard');
            const btnPdf = document.getElementById('tab-report');

            if(tab === 'dashboard') {
                dashboard.style.display = 'flex';
                pdf.style.display = 'none';
                btnDash.classList.add('active');
                btnPdf.classList.remove('active');
                
                // Resize charts if needed when becoming visible
                if(myChart) myChart.resize();
                if(myRadarChart) myRadarChart.resize();

            } else {
                dashboard.style.display = 'none';
                pdf.style.display = 'block';
                btnDash.classList.remove('active');
                btnPdf.classList.add('active');

                // Init PDF if first time
                if(!pdfDoc) {
                    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
                        pdfDoc = pdfDoc_;
                        renderPage(pageNum);
                    }).catch(err => {
                        console.error("PDF Load Error:", err);
                        document.querySelector('.pdf-canvas-container').innerHTML = 
                            `<div style="color:white; padding:20px;">
                                <h3>Could not load PDF Preview.</h3>
                                <p>Please ensure the file "2025 Brunei GTCI Ranking (1).pdf" is in the root directory.</p>
                                <a href="${url}" style="color:#42a5f5">Click here to download directly.</a>
                            </div>`;
                    });
                } else {
                    // Re-render to ensure size is correct
                    queueRenderPage(pageNum);
                }
            }
        }

        // --- INIT ---
        window.onload = function() {
            initIndicators();
            renderInputs();
            renderTable();
            renderChart();
            renderRadarChart();
            updateSummary();
                // Ensure 'All' filter button is marked as active
    document.querySelector('[onclick*="setFilter(\'status\', \'all\'"]').classList.add('active');
                if (filters.year === '2023') { document.getElementById('indicatorCount').textContent = '(69)'; }
        };

    </script>
</body>
</html>
